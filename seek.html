<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Idea Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Basis-Hintergrundfarbe für Light Mode */
            background-color: #f7f9fb; 
        }
        /* Dunkler Hintergrund für Dark Mode */
        .dark body {
            background-color: #111827; 
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 transition-colors duration-300">

    <div class="w-full max-w-3xl bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100 
            dark:bg-gray-800 dark:shadow-2xl dark:border-gray-700 transition-colors duration-300">
        <header class="text-center mb-8 relative">
           
            <!-- THEME TOGGLE BUTTON -->
            <button id="themeToggle" class="absolute right-0 top-0 p-2 rounded-full text-gray-500 hover:text-indigo-600 
                                            dark:text-gray-400 dark:hover:text-indigo-400 transition duration-150">
                <!-- Sun Icon (Light Mode) -->
                <svg id="sunIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon (Dark Mode) -->
                <svg id="moonIcon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
           
            <h1 class="text-3xl font-bold text-indigo-700 dark:text-indigo-400 transition-colors duration-300">AI Idea Assistant</h1>
            <p class="text-gray-500 mt-2 dark:text-gray-400 transition-colors duration-300">Generiert Ideen und begrenzt den Zugriff, um Ihre API-Kosten zu schützen.</p>
        </header>

        <!-- User Input Area -->
        <div class="mb-6">
            <label for="userPrompt" class="block text-lg font-medium text-gray-700 mb-2 dark:text-gray-300 transition-colors duration-300">Welche Idee möchten Sie generieren?</label>
            <textarea id="userPrompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm
                dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition-colors duration-300"
                placeholder="Z.B. Schreiben Sie drei aufregende Wendungen für eine futuristische Detektivgeschichte über Zeitreisen."></textarea>
        </div>

        <!-- Action Button and Loading Spinner -->
        <button id="generateBtn"
            class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center">
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="buttonText">Idee generieren</span>
        </button>

        <!-- Output Area -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2 dark:text-gray-300 dark:border-gray-600 transition-colors duration-300">Generierte Ausgabe:</h2>
            <div id="outputArea" class="min-h-32 p-4 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap text-gray-800 
                dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition-colors duration-300">
                <!-- AI generated content will appear here -->
                Die generierten Inhalte sind kontextabhängig und einzigartig basierend auf Ihrer Eingabe.
            </div>
        </div>
    </div>

    <!-- Firebase and AI Logic -->
    <script type="module">
        // --- Dark Mode Logic ---
        const root = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
       
        function toggleDarkMode() {
            if (root.classList.contains('dark')) {
                // Wechsel zu Light Mode
                root.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                // Wechsel zu Dark Mode
                root.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            // Standardmäßig den System-Modus verwenden, falls keine Präferenz gespeichert ist
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
           
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                root.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                root.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }
       
        // Initialisiere das Theme beim Laden der Seite
        document.addEventListener('DOMContentLoaded', initializeTheme);
        themeToggle.addEventListener('click', toggleDarkMode);
        // --- End Dark Mode Logic ---

        // Mandatory Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, getDoc, updateDoc, setDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // *** NEUER IMPORT ***
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";


        // --- GLOBAL SETUP (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let functions = null; // *** HINZUGEFÜGT ***
        let callGeminiApiProxy = null; // *** HINZUGEFÜGT ***
        let isAuthReady = false;
        let userId = null;

        if (firebaseConfig) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            functions = getFunctions(app); // *** HINZUGEFÜGT ***

            // *** HINZUGEFÜGT: Referenz zur Cloud Function ***
            callGeminiApiProxy = httpsCallable(functions, 'callGeminiApiProxy');

        }

        async function authenticateUser() {
            try {
                if (auth) {
                    if (initialAuthToken) {
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        userId = userCredential.user.uid;
                    } else {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                    }
                }
                isAuthReady = true;
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                userId = 'anonymous_user'; // Fallback if auth fails entirely
            }
        }

        // Run authentication immediately
        authenticateUser();
        // --- END GLOBAL SETUP ---

        // --- API & RATE LIMITING LOGIC ---

        // Der Modellname wird jetzt an die Cloud Function übergeben
        const modelName = "gemini-2.5-flash-preview-09-2025";

        // *** ENTFERNT ***
        // const apiKey = "..." 
        // const apiUrl = "..."

        const DAILY_LIMIT = 10; // Maximal 10 Aufrufe pro 24 Stunden
        const MS_PER_DAY = 24 * 60 * 60 * 1000;

        // Element-Referenzen
        const generateBtn = document.getElementById('generateBtn');
        const userPromptEl = document.getElementById('userPrompt');
        const outputArea = document.getElementById('outputArea');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');

        /**
         * Prüft die Nutzungsbeschränkung des Benutzers in Firestore und erhöht den Zähler.
         * (Diese Funktion bleibt unverändert)
         */
        async function checkAndIncrementUsage() {
            if (!db || !userId) {
                console.error("Firestore oder UserID nicht verfügbar.");
                return false;
            }

            // Pfad: /artifacts/{appId}/users/{userId}/usage/gemini
            const usageDocRef = doc(db, 'artifacts', appId, 'users', userId, 'usage', 'gemini');

            try {
                const usageSnap = await getDoc(usageDocRef);
                const now = Date.now();
                let requestCount = 0;
                let lastRequest = 0;

                if (usageSnap.exists()) {
                    const data = usageSnap.data();
                    requestCount = data.requestCount || 0;
                    lastRequest = data.lastRequest?.toMillis() || 0;

                    // Prüfe, ob 24 Stunden seit dem letzten Aufruf vergangen sind.
                    if (now - lastRequest > MS_PER_DAY) {
                        // Wenn ja, setze den Zähler zurück
                        requestCount = 0;
                    }
                }

                if (requestCount >= DAILY_LIMIT) {
                    // Limit erreicht
                    const nextReset = lastRequest > 0 ? new Date(lastRequest + MS_PER_DAY).toLocaleTimeString() : 'morgen';
                    outputArea.textContent = `FEHLER: Sie haben Ihr tägliches Limit von ${DAILY_LIMIT} Aufrufen erreicht. Bitte versuchen Sie es ${nextReset} erneut. Ihre ID: ${userId}`;
                    return false;
                }

                // Aufruf zulässig: Erhöhe den Zähler und aktualisiere den Zeitstempel
                await setDoc(usageDocRef, {
                    requestCount: increment(1),
                    lastRequest: serverTimestamp(),
                    userId: userId // Optional, zur besseren Übersicht
                }, { merge: true });

                return true;

            } catch (error) {
                console.error("Fehler bei der Nutzungsprüfung (Firestore):", error);
                outputArea.textContent = "Ein Fehler ist bei der Nutzungsprüfung aufgetreten. Bitte in der Konsole nachsehen.";
                return false; // Bei Fehler sicherheitshalber blockieren
            }
        }

        // *** KOMPLETT ÜBERARBEITET ***
        /**
         * Ruft die sichere Firebase Cloud Function (Proxy) auf.
         * @param {string} userQuery Die Benutzereingabe.
         * @returns {Promise<string>} Der vom Modell generierte Text.
         */
        async function callGeminiApi(userQuery) {
            
            if (!callGeminiApiProxy) {
                 return "FEHLER: Die Firebase Cloud Function-Referenz ist nicht initialisiert.";
            }

            try {
                // Übergebe die notwendigen Daten an die Cloud Function
                const result = await callGeminiApiProxy({ 
                    userQuery: userQuery,
                    modelName: modelName 
                });
                
                // 'result.data' enthält das Objekt, das wir von der Funktion zurückgegeben haben
                return result.data.generatedText;

            } catch (error) {
                console.error("Cloud Function-Aufruffehler:", error);
                // 'error.message' enthält die Fehlermeldung, die von der Funktion geworfen wurde
                return `Ein Fehler ist aufgetreten: ${error.message}`;
            }
        }

        async function generateIdea() {
            if (!isAuthReady) {
                outputArea.textContent = "Authentifizierung ist noch nicht bereit. Bitte warten Sie einen Moment.";
                return;
            }

            if (!firebaseConfig) {
                 outputArea.textContent = "FEHLER: Firebase-Konfiguration nicht gefunden. App kann nicht ausgeführt werden.";
                 return;
            }

            const userQuery = userPromptEl.value.trim();
            if (userQuery === "") {
                outputArea.textContent = "Bitte geben Sie eine Eingabeaufforderung ein, um eine Idee zu generieren.";
                return;
            }
           
            // 1. Nutzungsprüfung durchführen und Zähler erhöhen
            const isAllowed = await checkAndIncrementUsage();
            if (!isAllowed) {
                // Die Fehlermeldung wird bereits von checkAndIncrementUsage gesetzt
                return;
            }


            // UI aktualisieren
            generateBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = "Generiere...";
            outputArea.textContent = "Verarbeitung Ihrer Anfrage... (Prüfung bestanden!)";
            outputArea.classList.add('animate-pulse');

            // 2. Sicherer API-Aufruf über die Cloud Function
            const generatedText = await callGeminiApi(userQuery);

            // UI zurücksetzen
            outputArea.classList.remove('animate-pulse');
            generateBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = "Idee generieren";
           
            // Ausgabe anzeigen
            outputArea.textContent = generatedText;
        }

        // Attach event listener
        generateBtn.addEventListener('click', generateIdea);

    </script>
</body>
</html>
